---
title: "MTH6139 Time Series" 
subtitle: "Apple Forecast" 
author: "Mogboluwagunte Jedidiah Odukoya" 
date: "Spring term 2025" 
output: 
  html_document:
    toc: true
    toc_float: true
    theme: spacelab 
    highlight: zenburn
---
 
```{r, echo=FALSE}
# This code will display the QMUL logo at the top right of the page
# Do not change this code
htmltools::img(src = knitr::image_uri("images/QMlogo.png"),
               alt = 'logo',
               style = 'position:absolute; top:0; right:0; padding:10px; width:20%;')
```

# Section 1: INTRODUCTION



As someone who has had an interest in the stock market for a long time I was curious as to how technology stocks in the market develop over time. So I decided to look at Apple stocks and how they have been performing since COVID. 

This aims to cover the historical data of the stock price of Apple. Especially including the last 5 years and any possible effects of COVID-19. I aim to create a time series (TS) and use forecasts such as Prophet to predict future changes in the stock prices, and also decomposing the TS to analyse trend, seasonality and the random variability over time. By comparing different ranges of time I can get a greater understanding of the long-term and short-term fluctuation in the stock price.


<br><br>

# Section 2: PROPHET


## 2.1 Explaining the Code

-**WHAT DO THESE LIBRARIES DO:**
    
    - prophet - allows for forecasting of a time series
    `
    - quantmod - allows for financial stock data to be obtained from yahoo finance.

*DF_apple5* / *DF_apple20* stores the adjusted closing price of the apple stocks obtained from  yahoo as a data frame whilst simulataneously removing any N/A  to allow for only numrical inputs.

*TimeSeries_apple5* / *TimeSeries_apple20* is the variable containing the time series of the adjusted closing price starting from 1st of January 2020 and 1st of January 2005 respectively. The frequency is 251 as that is how many trading days there are in a year and would therefore be the length of the seasonality.

*linearRStockP5* / *linearRStockP20* is the variable which contains the data for the linear regression of the data.

*stockprice_df5* / *stockprice_df20* creates a dataframe and *ds* is assigned a date from DF_apple5 / DF_apple20 and *y* the adjusted closing values of the Apple stock.

<br>

## 2.2 Apple Stock over the last 20 Years

### 2.2.1 The Code

```{R}
library(prophet)
library(quantmod)
getSymbols("AAPL", src = "yahoo", from = "2005-01-01", to = Sys.Date()
          )

DF_apple20 = data.frame(Date = index(AAPL), coredata(AAPL))
#head(DF_apple20)
#tail(DF_apple20)
max(DF_apple20$AAPL.Adjusted)
min(DF_apple20$AAPL.Adjusted)
mean(DF_apple20$AAPL.Adjusted)
sd(DF_apple20$AAPL.Adjusted)

#length(DF_apple20$AAPL.Adjusted)
DF_apple20 = DF_apple20[!is.na(DF_apple20$AAPL.Adjusted), ]
TimeSeries_apple20 = ts(DF_apple20$AAPL.Adjusted, start = c(2005, 1), frequency = 251)

stockprice_df20 = data.frame(
    ds = DF_apple20$Date,
    y = as.numeric(TimeSeries_apple20)
)
#head(stockprice_df20,251)

linearRStockP20 = lm(y ~ ds, data = stockprice_df20)
summary(linearRStockP20)

plot(stockprice_df20)


currDat20 = prophet(stockprice_df20)
futureDat20 = make_future_dataframe(currDat20, periods=502, freq ="day")
prediction20 =  predict(currDat20, futureDat20)
plot(currDat20, prediction20)

prophet_plot_components(currDat20, prediction20)

plot(decompose(TimeSeries_apple20, type = "multiplicative"))

```


### 2.2.2 Analysing the Data
The **linear regression** has a negative *intercept* but as the ds value is time it can be ignored and has no real effect on the data. The positive slope "ds" of value 0.0269 shows that there is an increase in stock price over time. This is shown to be  very significant when you look at the p-value which is <2e-16. 

As expected of a large company such as Apple they have an increasing trend in their stock prices. They seem to have a seasonality of 1 year. Furthermore as there seems to be no explained variability in the randomness the model seems to be a good fit.

During later years the data points often fall out of the confidence interval predicted by the model, and in the predicted years the confidence interval increases implying that there is more uncertainty as the number of predictions increase.

However there are large volatility spikes after the year 2020 and so it would be good to zoom in and see what exactly happens there.

<br>

## 2.3 A Zoom in to the Last 5 Years

### 2.3.1 The Code

```{r}
library(prophet)
library(quantmod)
getSymbols("AAPL", src = "yahoo", from = "2020-01-01", to = Sys.Date()
          )

DF_apple5 = data.frame(Date = index(AAPL), coredata(AAPL))
#head(DF_apple5)
#tail(DF_apple5)
max(DF_apple5$AAPL.Adjusted)
min(DF_apple5$AAPL.Adjusted)
mean(DF_apple5$AAPL.Adjusted)
sd(DF_apple5$AAPL.Adjusted)

#length(DF_apple5$AAPL.Adjusted)
DF_apple5 = DF_apple5[!is.na(DF_apple5$AAPL.Adjusted), ]
TimeSeries_apple5 = ts(DF_apple5$AAPL.Adjusted, start = c(2020, 1), frequency = 251)

stockprice_df5 = data.frame(
    ds = DF_apple5$Date,
    y = as.numeric(TimeSeries_apple5)
)
#head(stockprice_df5,251)



linearRStockP5 = lm(y ~ ds, data = stockprice_df5)
summary(linearRStockP5)

plot(stockprice_df5)


currDat5 = prophet(stockprice_df5)
futureDat5 = make_future_dataframe(currDat5, periods=502, freq ="day")
prediction5 =  predict(currDat5, futureDat5)
plot(currDat5, prediction5)

prophet_plot_components(currDat5, prediction5)

plot(decompose(TimeSeries_apple5, type = "multiplicative"))


```


### 2.3.2 Analysing Data

This graph is highly volatile which is shown by the fact there are a lot of data points which can be found outside of the confidence interval and a comparatively large confidence interval (which is to be expected) during the prediction dates.

Similarly to before the summary statistics show that there is a positive correlation between time and stock price, and with a p-value which is <2e-16 we can once again say that the data is significant.

By zooming it can be seen that Apple have a seasonality of 1 year and as the data suggests there is an increase in stock prices which lines up roughly with the news of release of new products peaking around what seems to be the September mark when Apple often release new iPhones. Furthermore, once again, as there seems to be no explained variability in the randomness the model seems to be a good fit.


<br><br>

# Section 3: CONCLUSION

To conclude the less data you have, the broader the confidence interval is and the worse the prediction seems. However the economy is constantly changing with new laws and practices being put in place which effects businesses and companies such as Apple which could make data gathered from 2010 less applicable than data found in 2020. This is especially shown by a massive spike in the stock price of Apple in 2020 which could be down to COVID-19 and consumer need for entertainment and remote work.Event such as these would not be represented at all in the 2010 data, potentially making it less relevant. However this would often be picked up by the randomness in the decomposition and not effect trend and seasonality.

Having a weighted prediction could help make the confidence interval more accurate and allow for better predictions and better purchasing of stocks.



# References

- Datacamp course: <https://www.datacamp.com/courses/reporting-with-rmarkdown>
- RStudio reference: <https://rmarkdown.rstudio.com/lesson-1.html>
- More sophisticated reference: <https://bookdown.org/yihui/rmarkdown/>
- Yahoo apple data : <https://finance.yahoo.com/quote/AAPL/>
